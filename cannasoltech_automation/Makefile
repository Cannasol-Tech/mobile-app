# Cannasol Technologies Mobile App - Testing Makefile
# 
# This Makefile provides standardized testing targets per company Flutter Testing Standard
# All targets follow the testing pyramid distribution: 70% unit, 20% widget, 10% integration
#
# Usage:
#   make test           - Run complete test suite
#   make test-unit      - Run unit tests only (â‰¥85% coverage)
#   make test-widget    - Run widget tests only (â‰¥70% coverage)
#   make test-golden    - Run golden tests (visual regression)
#   make test-integration - Run integration tests
#   make coverage       - Generate coverage report
#   make clean-test     - Clean test artifacts

.PHONY: help test test-unit test-widget test-widget-legacy test-widget-suite test-components test-pages test-dialogs test-golden test-golden-components test-integration coverage clean-test setup-test

# Default target
help:
	@echo "Cannasol Technologies Mobile App - Testing Targets"
	@echo ""
	@echo "Available targets:"
	@echo "  test              - Run complete test suite (unit + widget + integration)"
	@echo "  test-unit         - Run unit tests (â‰¥85% coverage required, mocking allowed)"
	@echo "  test-widget       - Run widget tests (â‰¥85% coverage required, dependency mocking allowed via Mocktail; do not mock widgets/rendering)"
	@echo "  test-widget-suite - Run comprehensive widget test suite"
	@echo "  test-widget-legacy- DEPRECATED: alias to test-widget"
	@echo "  test-components   - Run component widget tests"
	@echo "  test-pages        - Run page widget tests"
	@echo "  test-dialogs      - Run dialog widget tests"
	@echo "  test-golden       - Run golden tests (visual regression)"
	@echo "  test-integration  - Run integration tests (critical paths)"
	@echo "  coverage          - Generate and display coverage report"
	@echo "  clean-test        - Clean test artifacts and coverage files"
	@echo "  setup-test        - Setup test environment and dependencies"
	@echo ""
	@echo "Coverage Requirements (per Flutter Testing Standard):"
	@echo "  Unit Tests:       â‰¥85% statement coverage (mocking allowed)"
	@echo "  Widget Tests:     â‰¥85% widget coverage (dependency mocking allowed via Mocktail; do not mock widgets/rendering)"
	@echo "  Overall Project:  â‰¥80% total coverage"
	@echo ""
	@echo "Company Standard: .axovia-flow/company-standards/flutter-specific/flutter-testing-standard.md"

# Setup test environment
setup-test:
	@echo "Setting up test environment..."
	flutter pub get
	@echo "Test environment ready!"

# Complete test suite
test: test-unit test-widget test-integration
	@echo "âœ… Complete test suite passed!"
	@echo "Running coverage analysis..."
	@$(MAKE) coverage

# Unit Testing (with mocking allowed)
# Executes: flutter test test/unit/
# Coverage: â‰¥85% requirement
# Mocking: Mocktail permitted
test-unit:
	@echo "ğŸ§ª Running unit tests..."
	@echo "Target: â‰¥85% coverage | Mocking: Permitted (Mocktail)"
	flutter test test/unit/ --coverage --reporter=expanded
	@echo "âœ… Unit tests completed"


# Widget Testing (dependency mocking allowed via Mocktail; do not mock widgets/rendering)
# Executes: flutter test test/widget/
# Coverage: â‰¥85% requirement
# Mocking: Allowed for external dependencies via Mocktail; Mockito prohibited
# Standard: .axovia-flow/company-standards/flutter-specific/flutter-testing-standard.md
test-widget:
	@echo "ğŸ¨ Running widget tests..."
	@echo "Standard: Flutter Testing Standard | Coverage: â‰¥85% | Mocking: Allowed for external dependencies via Mocktail; do not mock widgets/rendering"
	@echo "ğŸ“‹ Validating compliance with mocking framework policy (Mockito prohibited)..."
	@if grep -R -n -E "package:mockito|Mockito" test/widget/ --include="*.dart" >/dev/null 2>&1; then \
		echo "âŒ VIOLATION: Mockito detected in widget tests! Use Mocktail instead."; \
		echo "   Standard: .axovia-flow/company-standards/flutter-specific/flutter-testing-standard.md"; \
		exit 1; \
	else \
		echo "âœ… No prohibited frameworks detected"; \
	fi
	flutter test test/widget/ --coverage --reporter=expanded
	@echo "âœ… Widget tests completed with coverage"
	@echo "ğŸ“Š Validating coverage requirements..."
	@if [ -f coverage/lcov.info ]; then \
		echo "Coverage report generated: coverage/lcov.info"; \
		if command -v lcov >/dev/null 2>&1; then \
			echo "Widget test coverage summary:"; \
			lcov --summary coverage/lcov.info | grep -E "(lines|functions)"; \
		fi; \
	else \
		echo "âš ï¸  Coverage file not found"; \
	fi

# Widget Test Suite (comprehensive)
test-widget-suite:
	@echo "ğŸ¨ Running comprehensive widget test suite..."
	flutter test test/widget/widget_test_suite.dart --reporter=expanded
	@echo "âœ… Widget test suite completed"

# Component-specific widget tests
test-components:
	@echo "ğŸ§© Running component widget tests..."
	flutter test test/widget/components/ --reporter=expanded
	@echo "âœ… Component tests completed"

# Page-specific widget tests
test-pages:
	@echo "ğŸ“„ Running page widget tests..."
	flutter test test/widget/pages/ --reporter=expanded
	@echo "âœ… Page tests completed"

# Dialog-specific widget tests
test-dialogs:
	@echo "ğŸ’¬ Running dialog widget tests..."
	flutter test test/widget/dialogs/ --reporter=expanded
	@echo "âœ… Dialog tests completed"

# Widget tests with coverage (DEPRECATED - use test-widget instead)
test-widget-coverage:
	@echo "ğŸ¨ğŸ“Š Running widget tests with coverage..."
	@echo "âš ï¸  DEPRECATED: Use 'make test-widget' instead (includes coverage)"
	flutter test test/widget/ --coverage --reporter=expanded
	@echo "âœ… Widget tests with coverage completed"

# Legacy widget testing (TEMPORARY - for migration period only)
# âš ï¸  WARNING: This target bypasses company standards and should only be used
# during the migration period to remove mocking from widget tests
test-widget-legacy:
	@echo "ğŸ¨âš ï¸  LEGACY target is deprecated. Using standard widget tests (mocking dependencies allowed via Mocktail)."
	$(MAKE) test-widget

# Run only compliant widget tests (no mocking violations)
test-widget-compliant:
	@echo "ğŸ¨âœ… Running compliant widget tests (Mocktail allowed; Mockito prohibited)..."
	@echo "Standard: Flutter Testing Standard | Coverage: â‰¥85% | Mocking: Allowed for external dependencies via Mocktail; do not mock widgets/rendering"
	@echo "Validating widget tests for prohibited frameworks..."
	@if grep -R -n -E "package:mockito|Mockito" test/widget/ --include="*.dart" >/dev/null 2>&1; then \
		echo "âŒ VIOLATION: Mockito detected in widget tests! Use Mocktail instead."; \
		exit 1; \
	else \
		echo "âœ… No prohibited frameworks detected"; \
	fi
	flutter test test/widget/ --coverage --reporter=expanded
	@echo "âœ… Compliant widget tests completed"
	@echo "ğŸ“Š Coverage report generated for compliant tests"

# Golden Testing (visual regression)
# Executes: flutter test with golden file generation
# Mocking: PROHIBITED
test-golden:
	@echo "ğŸ–¼ï¸  Running golden tests (visual regression)..."
	@echo "Mocking: PROHIBITED | Purpose: Visual consistency"
	flutter test --dart-define=ENABLE_GOLDEN_TESTS=true test/widget/ --reporter=expanded
	@echo "âœ… Golden tests completed"

# Golden tests for specific components
test-golden-components:
	@echo "ğŸ–¼ï¸  Running component golden tests..."
	flutter test --dart-define=ENABLE_GOLDEN_TESTS=true test/widget/components/ --reporter=expanded
	@echo "âœ… Component golden tests completed"

# Update golden files (use with caution)
update-goldens:
	@echo "ğŸ”„ Updating golden files..."
	@echo "âš ï¸  WARNING: This will update all golden reference images"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	flutter test --dart-define=ENABLE_GOLDEN_TESTS=true --update-goldens test/widget/
	@echo "âœ… Golden files updated"

# Update golden files for specific components
update-goldens-components:
	@echo "ğŸ”„ Updating component golden files..."
	@echo "âš ï¸  WARNING: This will update component golden reference images"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	flutter test --dart-define=ENABLE_GOLDEN_TESTS=true --update-goldens test/widget/components/
	@echo "âœ… Component golden files updated"

# Integration Testing (end-to-end)
# Executes: flutter test integration_test/
# Mocking: PROHIBITED
test-integration:
	@echo "ğŸ”— Running integration tests..."
	@echo "Scope: Critical user flows | Mocking: PROHIBITED"
	flutter test integration_test/ --reporter=expanded
	@echo "âœ… Integration tests completed"

# Coverage analysis and reporting
coverage:
	@echo "ğŸ“Š Generating coverage report..."
	flutter test --coverage
	@if command -v lcov >/dev/null 2>&1; then \
		echo "Generating HTML coverage report..."; \
		genhtml coverage/lcov.info -o coverage/html --ignore-errors source; \
		echo "ğŸ“ˆ Coverage report generated: coverage/html/index.html"; \
	else \
		echo "âš ï¸  lcov not installed. Install with: brew install lcov"; \
	fi
	@echo "ğŸ“‹ Coverage summary:"
	@if command -v lcov >/dev/null 2>&1; then \
		lcov --summary coverage/lcov.info; \
	else \
		echo "Install lcov for detailed coverage summary"; \
	fi

# Coverage validation (CI/CD use)
validate-coverage:
	@echo "ğŸ” Validating coverage requirements..."
	@if [ ! -f coverage/lcov.info ]; then \
		echo "âŒ Coverage file not found. Run 'make test' first."; \
		exit 1; \
	fi
	@echo "âœ… Coverage validation completed"

# Clean test artifacts
clean-test:
	@echo "ğŸ§¹ Cleaning test artifacts..."
	rm -rf coverage/
	rm -rf test/golden/failures/
	flutter clean
	@echo "âœ… Test artifacts cleaned"

# Development helpers
test-watch:
	@echo "ğŸ‘€ Running tests in watch mode..."
	flutter test --reporter=expanded --watch

test-debug:
	@echo "ğŸ› Running tests in debug mode..."
	flutter test --reporter=expanded --debug

# Platform-specific testing
test-ios:
	@echo "ğŸ Running tests for iOS..."
	flutter test --platform=ios

test-android:
	@echo "ğŸ¤– Running tests for Android..."
	flutter test --platform=android

test-web:
	@echo "ğŸŒ Running tests for Web..."
	flutter test --platform=web

# Quality gates for CI/CD
quality-gate: test validate-coverage
	@echo "ğŸšª Quality gate passed!"
	@echo "âœ… All tests passed"
	@echo "âœ… Coverage requirements met"

# Firebase emulator setup (for integration tests)
setup-firebase-emulator:
	@echo "ğŸ”¥ Setting up Firebase emulator..."
	@if command -v firebase >/dev/null 2>&1; then \
		firebase emulators:start --only auth,database,storage; \
	else \
		echo "âŒ Firebase CLI not installed. Install with: npm install -g firebase-tools"; \
		exit 1; \
	fi

# Test data management
generate-test-data:
	@echo "ğŸ“ Generating test data..."
	dart run test/helpers/generate_test_data.dart

# Performance testing
test-performance:
	@echo "âš¡ Running performance tests..."
	flutter test test/performance/ --reporter=expanded

# Lint and format before testing
pre-test: 
	@echo "ğŸ”§ Running pre-test checks..."
	dart format --set-exit-if-changed .
	flutter analyze
	@echo "âœ… Pre-test checks passed"

# Full CI/CD pipeline simulation
ci-test: pre-test test quality-gate
	@echo "ğŸš€ CI/CD pipeline simulation completed successfully!"
